{{- define "main" -}}

  <!-- The current page, to pass along to children templates -->
  {{ $page := $ }}

  <!-- Get webinars, excluding the upcoming webinar advertised in header -->
  {{ $webinarPages := where $page.Pages "Kind" "page" }}

  <!-- Get upcoming webinar -->
  {{ $upcomingWebinarPage := partial "functions/getUpcomingWebinar" (dict "webinars" $webinarPages) }}

  <!-- Make the header Block -->
  {{ with $headerBlock := .Params.header }}
    {{ $headerBlock = merge $headerBlock (dict "next_webinar" $upcomingWebinarPage) }}
    {{ partial "blocks/header/header--webinars.html" (dict "Block" $headerBlock "Page" $page) }}
  {{ end }}

  <!-- If there are sections in the index page content, generated them -->
  {{- range .Params.page_sections -}}
    {{ if .template }}
      {{ partial (printf "blocks/%s/%s.html" .template .template) (dict "Block" . "Page" $page) }}
    {{ end }}
  {{- end -}}

  <!-- PAST WEBINARS LIST -->

  <!-- Don't list the upcoming webinar shown in the header -->
  {{ if $upcomingWebinarPage }}
    {{ $webinarPages = $webinarPages | complement (slice $upcomingWebinarPage) }}
  {{ end }}

  {{ $webinarPages = ($webinarPages.ByParam "webinar_datetime").Reverse }}
  {{ $webinarsBlock := dict "template" "webinar-list" "webinars" $webinarPages }}

  {{ $sectionBlock := dict "template" "section" "blocks" (slice $webinarsBlock) "title" "Past webinars" "id" "past-webinars"}}
  {{ partial "blocks/section/section" (dict "Block" $sectionBlock "Page" $) }}

{{- end -}}