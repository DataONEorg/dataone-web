<!-- ================================================================= -->
<!-- Common variables -->

<!-- In order to pass on page parameters from within loops -->
{{ $page := .Page }}
<!-- Block name -->
{{ $bn := "webinar-list" }}
<!-- Classes for the outermost element -->
{{ $classes := $bn }}

{{ $webinarPages := .Block.webinars }}

<!-- Search Icon -->
{{ $iconBlock := dict "size" "small" "stroke" "thinner"  "icon" "search" "color" "inherit" }}
{{ $searchIcon := partial "blocks/icon/icon" (dict "Block" $iconBlock "Page" $page) }}

<!-- Get unique webinar years -->
{{ $years := slice }}
{{ range $webinar := $webinarPages }}
  {{ $date := $webinar.Params.webinar_datetime }}
  {{ $year := dateFormat "2006" $date }}
  {{ $years = $years | append $year }}
{{ end }}
{{ $years = $years | uniq | sort }}

<!-- Get all webinar categories -->
{{ $tags := slice }}
{{ $webinarsIndex := where (where ($page.Site.Pages) "Section" "webinars") "Kind" "section" }}
{{ range $webinarsIndex }}
  {{ $tags = .Params.webinar_tags }}
{{ end }}

{{ $filters := slice (dict "name" "year" "label" "year" "options" $years) (dict "name" "tags" "label" "data lifecycle stage" "options" $tags)  }}

{{ if $webinarPages }}

  {{ $numWebinars := len $webinarPages }}

  <!----------------------------------------------------------------------------->
  <!-- START LAYOUT -->

  <div class="{{ $classes }}" id="past-webinars">

    <!-- FILTERS -->
    <form class="{{ $bn }}__filters">

      <!-- SEARCH INPUT -->
      <div class="{{ $bn }}__search-area">
        <input class="{{ $bn }}__input" type="text" id="webinarSearch" placeholder="Enter a search term" onkeyup="toggleFilter(filter = 'searchTerm', option = this.value, element = this)">
        <label class="{{ $bn }}__label" for="webinarSearch">
          Search for a webinar
        </label>
        <span class="{{ $bn }}__search-icon">
          {{ $searchIcon }}
        </span>
      </div>

      <!-- FILTER CHIPS -->
      {{ range $filter := $filters }}
        {{ $id := printf "filter-%s" $filter.name }}
        <fieldset class="{{ $bn }}__filter" id="{{ $id }}">
          <legend class="{{ $bn }}__filter-legend">
            Filter by
            {{ $filter.label }}
          </legend>

          {{ range $filter.options }}
            {{ $cb_id := printf "cb_%s_%s"  ( $filter.name | urlize) ( . | urlize ) }}
            <div class="{{ $bn }}__filter-chip">
              <input class="{{ $bn }}__filter-checkbox" id="{{ $cb_id }}" type="checkbox" name="{{ $filter.name }}" value="{{ . }}" onchange="toggleFilter(filter = {{ $filter.name }}, option = {{ . }}, element = this)">
              <label class="{{ $bn }}__filter-label" for="{{ $cb_id }}">{{ . }}</label>
            </div>
          {{ end }}

        </fieldset>
      {{ end }}

    </form>

    <div class="{{ $bn }}__results">
      <p class="{{ $bn }}__filter-text" id="filter-feedback-text" style="display:none">
        <span id="filter-feedback-text_num-results">0</span>
        out of
        {{ $numWebinars }}
        webinars matched your search
      </p>

      <ul class="{{ $bn }}__webinars">

        {{- range $webinarPage := ($webinarPages.ByParam "webinar_datetime").Reverse -}}

          {{ $webinar := $webinarPage.Params }}
          <!-- Get year and webinar data for webinar -->
          {{ $yearData := "" | safeHTMLAttr }}
          {{ $tagData := "" | safeHTMLAttr }}

          {{ with $webinar.webinar_datetime }}
            {{ $yearData = printf "data-year='%s'" (dateFormat "2006" .) | safeHTMLAttr  }}
          {{ end }}

          {{ $tags := $webinar.tags }}
          {{ if $tags }}
            {{ $tags = apply $tags "printf" `"%s"` "."  }}
            {{ $tags = delimit $tags ", " }}
            {{ $tagData = printf `data-tags='[%s]'` $tags  | safeHTMLAttr  }}
          {{ end }}

          <li {{ $yearData }} {{ $tagData }} class="{{ $bn }}__webinar">
            {{ $pageFilePath := $webinarPage.File.Path }}
            {{ $webinarBlock := (dict "type" "webinar" "webinar" $pageFilePath) }}
            {{ partial "blocks/page-summary/page-summary" (dict "Block" $webinarBlock "Page" $page) }}
          </li>

        {{- end -}}
      </ul>

      <p class="{{ $bn }}__paginate-text">Showing
        <span id="list-end_num-displayed">{{ $numWebinars }}</span>
        of
        <span id="list-end_num-results">{{ $numWebinars }}</span>
        <span id="list-end_filtered-text"></span>
        webinars
      </p>

      {{ partial "blocks/button/button" (dict "Block" (dict "text" "Show more" "id" "showMoreWebinars" "html_tag" "button" "function" `onclick="showMoreWebinars()"`) "Page" $page )}}

    </div>
  </div>
{{ end }}